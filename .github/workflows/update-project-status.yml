name: Update Project Status

# Update project status based on PR state
on:
  pull_request:
    types: [opened, closed, reopened]
  issues:
    types: [closed, reopened]

permissions:
  issues: write
  pull-requests: write

jobs:
  update-status:
    runs-on: ubuntu-latest
    name: Update project item status
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Project Status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
          EVENT_ACTION: ${{ github.event.action }}
          EVENT_TYPE: ${{ github.event_name }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Update Project Status"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Event Type: $EVENT_TYPE"
          echo "Action: $EVENT_ACTION"
          echo "Issue/PR Number: #$ISSUE_NUMBER"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Determine new status based on action
          case "$EVENT_ACTION" in
            opened)
              STATUS="Todo"
              LABEL_ADD="ğŸ“¥ state:pending"
              ;;
            closed)
              STATUS="Done"
              LABEL_ADD="âœ… state:done"
              LABEL_REMOVE="ğŸ“¥ state:pending,ğŸ—ï¸ state:implementing,ğŸ‘€ state:reviewing"
              ;;
            reopened)
              STATUS="In Progress"
              LABEL_ADD="ğŸ—ï¸ state:implementing"
              LABEL_REMOVE="âœ… state:done"
              ;;
            *)
              echo "â„¹ï¸ No status update needed for action: $EVENT_ACTION"
              exit 0
              ;;
          esac

          echo "ğŸ“ New Status: $STATUS"

          # Update labels if it's an issue event
          if [ "$EVENT_TYPE" = "issues" ]; then
            echo "ğŸ·ï¸ Updating labels..."

            # Add new state label
            if [ -n "$LABEL_ADD" ]; then
              gh issue edit "$ISSUE_NUMBER" --add-label "$LABEL_ADD" 2>/dev/null || true
            fi

            # Remove old state labels
            if [ -n "$LABEL_REMOVE" ]; then
              IFS=',' read -ra LABELS <<< "$LABEL_REMOVE"
              for label in "${LABELS[@]}"; do
                gh issue edit "$ISSUE_NUMBER" --remove-label "$label" 2>/dev/null || true
              done
            fi
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Status update complete: $STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
